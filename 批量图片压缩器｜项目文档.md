# 项目概述

**项目名称**：PicPress（可替换）  
**目标**：提供一个纯前端（默认）/ 可扩展到边缘函数的 **批量图片压缩** 网站，支持拖拽/选择文件、参数调节、实时预览、批量下载与历史记录。  
**技术栈**：Astro（框架/构建）、React（交互组件）、Tailwind CSS（样式）、TypeScript、Vite、Web Worker、OffscreenCanvas（可选）、PWA（可选）。

---

## 1. 需求与范围

### 1.1 核心功能
- 批量导入图片（拖拽/点击选择/粘贴剪贴板）。
- 支持格式：JPG/JPEG、PNG、WebP、AVIF、GIF（静态帧）。
- 输出格式选项：JPG、PNG、WebP、AVIF（浏览器支持自动降级）。
- 质量/压缩等级调节：质量（0–100）、分辨率限制（最长边/宽高自定义）、采样/下采样策略。
- 批量/单张预览：原图 vs 压缩后体积、尺寸、视觉差值（SSIM 近似）
- 批量导出：打包 ZIP 下载；或逐张保存。
- 任务并发控制：队列/暂停/继续/取消。
- 本地历史记录（IndexedDB）与参数预设。
- 国际化（i18n）与浅色/深色模式（可选）。

### 1.2 非功能性需求
- 体验：**极简**、响应式、无障碍（WCAG AA）。
- 性能：100 张 4K 照片的处理应保持 UI 不冻结（Web Worker + 分片）。
- 隐私：默认**离线处理**（不上传）。
- 浏览器支持：现代 Chromium/Firefox/Safari（近 2 年版本）。

---

## 2. 视觉与品牌（配色/风格）

- 整体风格：**简约**、留白充分。
- 主色：**白色**（背景/卡片主底）。
- 全局背景：**淡绿色**（示例：`#E8F5E9`）。
- 强调/交互：**淡红色**（示例：`#F8BBD0` 用作按钮/滑块轨迹/标签）。
- 字体：系统字体栈；标题中等字重，正文常规字重。
- 圆角：`rounded-2xl`；阴影：`shadow-lg/soft`。
- 动效：轻微的过渡与悬停缩放（`transition`, `motion-safe`）。

**Tailwind 主题建议**（`tailwind.config.ts`）：
```ts
// 简化示例
theme: {
  extend: {
    colors: {
      brand: {
        bg: '#E8F5E9',     // 淡绿色背景
        accent: '#F8BBD0', // 淡红色强调
        base: '#FFFFFF',   // 白色主色
      }
    }
  }
}
```

**全局样式**（`src/styles/global.css`）：
```css
:root { --bg:#E8F5E9; --accent:#F8BBD0; --base:#FFFFFF; }
html { background: var(--bg); }
.card { background: var(--base); }
```

---

## 3. 信息架构与路由

- `/`：首页（拖拽区、文件列表、压缩面板、预览区）。
- `/about`：项目说明与隐私声明。
- `/settings`：参数预设、并发配置、语言主题。
- `/*`：404。

**导航最小化**，主任务流聚焦在首页。

---

## 4. 页面布局（/）

1. **头部**：Logo（极简字标）+ 右侧设置/关于按钮。
2. **主区**（两列，移动端一列）：
   - 左列：**导入与列表**
     - 拖拽上传卡片（支持点击/粘贴）。
     - 文件表（缩略图、文件名、原始体积、状态、操作）。
   - 右列：**参数与预览**
     - 输出格式选择（JPG/PNG/WebP/AVIF）。
     - 质量滑块、尺寸限制（输入框或预设下拉）、锐化/去噪（可选）。
     - 预览：原图 vs 压缩后（切换/对比条）。
     - 批量操作：开始/暂停/取消、导出 ZIP。
3. **底部**：版权、隐私说明、GitHub 链接。

---

## 5. 组件设计（React）

- `DropZone`：拖拽/点击/粘贴。
- `FileList`：列表项 `FileRow`（缩略图、名称、体积、进度、单张导出）。
- `ControlsPanel`：格式/质量/尺寸/并发/预设。
- `PreviewPane`：前后对比图、数据统计。
- `ProgressBar`：全局与单项进度。
- `Toolbar`：开始/暂停/取消/导出。
- `SettingsDrawer`：语言、主题、性能开关、默认输出目录提示。
- `Toast`：错误与完成提示。

**状态流**
- 全局：Zustand 或 useReducer（队列、并发、任务状态）。
- 每个文件：`{ id, file, srcURL, resultBlob, status, progress, paramsSnapshot }`
- 参数：`{ format, quality, maxWidth, maxHeight, keepEXIF, concurrency }`

---

## 6. 压缩流程与并发

**数据流**
1. `File` -> 读取（`createImageBitmap`/`ImageBitmap`）。
2. 计算目标尺寸（保持比例，最长边限制）。
3. Web Worker 收到任务：
   - Canvas（`OffscreenCanvas` 优先，否则转主线程 Canvas 代理）
   - `ctx.drawImage` -> `canvas.convertToBlob({ type, quality })`
   - Safari 回退：`canvas.toBlob()`
4. 返回 `Blob` + 统计信息（压缩率、用时、尺寸）。
5. UI 更新进度与可视化对比。

**并发策略**
- 固定并发 `concurrency`（默认 3–4），任务队列 FIFO。
- 大图分片：可选（超大长图时分段绘制）。
- 失败重试：指数退避（最多 2 次）。

**伪代码**
```ts
// 主线程队列管理
while (queue.hasNext()) {
  if (running < concurrency) dispatchToWorker(queue.next())
}

// worker 内
onmessage = async (e) => {
  const { file, params } = e.data
  const bitmap = await createImageBitmap(file)
  const { w, h } = computeSize(bitmap, params)
  const canvas = new OffscreenCanvas(w, h)
  const ctx = canvas.getContext('2d')!
  ctx.drawImage(bitmap, 0, 0, w, h)
  const blob = await canvas.convertToBlob({ type: params.mime, quality: params.quality })
  postMessage({ ok: true, blob, meta: { w, h, time: performance.now() - start } })
}
```

**兼容性回退**
- 无 `OffscreenCanvas`：使用 `canvas` + `toBlob`（通过 `OffscreenCanvas` 特性检测降级）。
- 无 `createImageBitmap`：`HTMLImageElement` 加载 + `drawImage`。
- 无 `convertToBlob`：`toBlob`。

---

## 7. 文件组织结构

```
project-root
├─ astro.config.mjs
├─ package.json
├─ tailwind.config.ts
├─ src
│  ├─ pages
│  │  ├─ index.astro
│  │  ├─ about.astro
│  │  └─ settings.astro
│  ├─ components
│  │  ├─ DropZone.tsx
│  │  ├─ FileList.tsx
│  │  ├─ ControlsPanel.tsx
│  │  ├─ PreviewPane.tsx
│  │  ├─ Toolbar.tsx
│  │  └─ ui/* （按钮、对话框、滑块等）
│  ├─ workers
│  │  └─ compressor.worker.ts
│  ├─ lib
│  │  ├─ queue.ts
│  │  ├─ image.ts (尺寸/EXIF/类型判断)
│  │  └─ zip.ts (JSZip 打包)
│  ├─ store
│  │  └─ useAppStore.ts
│  └─ styles
│     └─ global.css
└─ public
   └─ icons/*
```

---

## 8. 关键页面与组件示例

### 8.1 `index.astro`（骨架，简化）
```astro
---
import ControlsPanel from "@/components/ControlsPanel";
import DropZone from "@/components/DropZone";
import FileList from "@/components/FileList";
import PreviewPane from "@/components/PreviewPane";
import Toolbar from "@/components/Toolbar";
---
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>PicPress</title>
  </head>
  <body class="min-h-screen bg-[var(--bg)] text-gray-800">
    <header class="sticky top-0 z-10 backdrop-blur">
      <div class="mx-auto max-w-6xl px-4 py-4 flex items-center justify-between">
        <h1 class="text-2xl font-medium">PicPress</h1>
        <nav class="flex gap-3">
          <a href="/settings" class="px-3 py-1 rounded-xl bg-brand-accent/50">设置</a>
          <a href="/about" class="px-3 py-1 rounded-xl">关于</a>
        </nav>
      </div>
    </header>
    <main class="mx-auto max-w-6xl px-4 py-8 grid md:grid-cols-2 gap-6">
      <section class="space-y-4">
        <DropZone />
        <FileList />
      </section>
      <section class="space-y-4">
        <ControlsPanel />
        <PreviewPane />
        <Toolbar />
      </section>
    </main>
    <footer class="py-10 text-center text-sm opacity-70">© 2025 PicPress</footer>
  </body>
</html>
```

### 8.2 `ControlsPanel.tsx`（片段）
```tsx
export default function ControlsPanel(){
  const [format, setFormat] = useStore(s=>[s.params.format, s.setFormat])
  const [quality, setQuality] = useStore(s=>[s.params.quality, s.setQuality])
  const [maxW, setMaxW] = useStore(s=>[s.params.maxWidth, s.setMaxWidth])
  return (
    <div className="card p-4 rounded-2xl shadow">
      <div className="flex gap-4 items-center">
        <label className="min-w-20">输出格式</label>
        <select value={format} onChange={e=>setFormat(e.target.value as any)} className="px-3 py-2 rounded-xl bg-brand-accent/30">
          <option>webp</option>
          <option>jpeg</option>
          <option>png</option>
          <option>avif</option>
        </select>
      </div>
      <div className="mt-4">
        <label className="flex justify-between"><span>质量</span><span>{quality}</span></label>
        <input type="range" min={1} max={100} value={quality} onChange={e=>setQuality(+e.target.value)} className="w-full accent-[var(--accent)]"/>
      </div>
      <div className="mt-4 flex gap-2">
        <label className="min-w-20">最长边</label>
        <input type="number" value={maxW} onChange={e=>setMaxW(+e.target.value)} className="w-28 px-3 py-2 rounded-xl bg-white/80"/>
        <span className="text-sm text-gray-500">px（0 表示保持原尺寸）</span>
      </div>
    </div>
  )
}
```

### 8.3 `compressor.worker.ts`（简化）
```ts
self.onmessage = async (e: MessageEvent) => {
  const { file, params, id } = e.data
  const start = performance.now()
  try {
    const bmp = await createImageBitmap(file)
    const { w, h } = computeSize(bmp.width, bmp.height, params)
    const c = new OffscreenCanvas(w, h)
    const ctx = c.getContext('2d', { alpha: true })!
    ctx.drawImage(bmp, 0, 0, w, h)
    const blob = await (c as any).convertToBlob ?
      (c as any).convertToBlob({ type: mime(params.format), quality: params.quality/100 }) :
      await new Promise<Blob>(res => (c as any).toBlob(res, mime(params.format), params.quality/100))
    const time = performance.now() - start
    ;(self as any).postMessage({ id, ok: true, blob, meta: { w, h, time } })
  } catch (err) {
    ;(self as any).postMessage({ id, ok: false, error: (err as Error).message })
  }
}
```

---

## 9. 数据与存储

- **IndexedDB**：存储参数预设、历史记录（哈希键 + 缩略图 DataURL）。
- **LocalStorage**：轻量开关（如是否保留 EXIF）。
- **文件系统访问 API**（可选）：选择默认输出目录（需要用户授权；Safari 限制）。

---

## 10. 无障碍与可用性

- 键盘完整可达；为 `DropZone` 提供 `aria-label` 与 `role="button"`；
- 对比度：淡红作为强调时需保证文字对比度 ≥ 4.5:1（可用深色文字或加描边/阴影）。
- 为进度与状态提供 `aria-live="polite"`；
- 拖拽同时提供显式“选择文件”按钮。

---

## 11. 性能优化

- Worker 内部解码与绘制，主线程只更新状态。
- 图片列表虚拟化（如 `react-virtual`）。
- 并发与节流：可动态探测硬件并发（`navigator.hardwareConcurrency`）。
- 大图优先缩放再压缩，避免高分辨率直接高质量编码。
- 懒加载缩略图与预览。

---

## 12. 打包与导出

- 使用 `JSZip` 将结果 `Blob` 批量打包为 `zip` 下载。
- 单张导出：`URL.createObjectURL(blob)` + `<a download>` 触发保存。
- 文件命名：`{原名}_{WxH}_q{质量}.{扩展名}`。

---

## 13. 部署与配置

- Astro 适配器：静态站点 (`@astrojs/vercel/static` 或 `astro build` + 任意静态托管)。
- 开发：`pnpm dev`，生产：`pnpm build && pnpm preview`。
- PWA（可选）：`vite-plugin-pwa`，离线缓存 UI（不缓存大文件）。
- CSP：限制 `img-src blob: data:`；`worker-src blob:`。

---

## 14. 测试与质量保障

- 单元测试：Vitest + React Testing Library（组件与 store）。
- E2E：Playwright（拖拽、压缩、导出 ZIP 流程）。
- 性能基线：使用 10 张 4000×3000 JPG，质量 80，记录平均用时与压缩比。
- 可访问性：`axe` 扫描 + 手动检查键盘路径。

---

## 15. 风险与对策

- **浏览器差异**：`convertToBlob`/`OffscreenCanvas` 支持差异 → 特性检测 + 回退。
- **内存压力**：大批量大图 → 限制并发 + 及时释放 `ImageBitmap.close()`。
- **色彩/EXIF**：去除 EXIF 可能影响色彩 → 提供“保留 EXIF”开关（注意体积变大）。
- **视觉损失**：高压缩质量可见 → 预览对比 + SSIM 指标提示。

---

## 16. 里程碑

- M1：基础 UI + 单张压缩（1 周）
- M2：批量队列 + 并发 + 预览（1–2 周）
- M3：ZIP 导出 + 历史记录（1 周）
- M4：PWA + i18n + 可访问性完善（1 周）

---

## 17. 依赖建议

- `zustand`（状态管理）
- `jszip`（打包）
- `file-saver`（可选，保存帮助）
- `react-dropzone` 或自研轻量拖拽
- `class-variance-authority`（样式变体，可选）

---

## 18. 隐私与法律

- 默认本地处理，不上传任何图片。
- 提示用户不要上传受版权/隐私保护的素材。
- 提供开源许可（如 MIT）与第三方库许可声明。

---

## 19. 成功指标（北极星）

- 单次会话内成功压缩并下载 ≥ 1 套图片的用户占比。
- 平均压缩比（输入体积 / 输出体积）。
- 任务失败率 < 0.5%。
- 互动延迟（主线程卡顿）P95 < 100ms。

---

## 20. 后续增强

- 服务端/边缘压缩（用于移动端低配设备）：`/api/compress`（Rate Limit + 付费阈值）。
- 支持 HEIC/HEIF（通过 WASM 编解码，需许可与性能评估）。
- 批量重命名/水印（可选）。
- 图像调色（亮度/对比/饱和度）与裁剪。

> 本文档为项目蓝图，可直接据此创建仓库与任务分解。需要我把模板仓库（Astro+React+Tailwind+Worker）脚手架也一起生成吗？

## 21. 作者联系方式

- 在网站导航栏和主页底部添加作者的联系方式。
- email：wanghongxiang23@gmail.com
- X：@Rollkey4

